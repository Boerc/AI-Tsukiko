<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tsukiko Dashboard</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 24px; max-width: 900px; margin: 0 auto; }
      h1 { margin-bottom: 0; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin: 16px 0; }
      label { display: block; margin: 8px 0 4px; font-weight: 600; }
      input, select, button, textarea { padding: 8px; border-radius: 6px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
      button { background: #111827; color: white; cursor: pointer; width: auto; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .small { font-size: 12px; color: #666; }
      code { background: #f5f5f5; padding: 2px 6px; border-radius: 4px; }
    </style>
  </head>
  <body>
    <h1>Tsukiko</h1>
    <p class="small">Web dashboard on port 8181</p>
    <div class="card">
      <h3>Auth</h3>
      <div class="row">
        <div>
          <label>API Key</label>
          <input id="apiKey" placeholder="optional if not set on server" />
        </div>
      </div>
      <div style="margin-top: 12px;">
        <button id="saveApiKey">Save</button>
      </div>
    </div>
    <div class="card gated">
      <h3>Health</h3>
      <pre id="health">Loading...</pre>
      <button id="refreshHealth">Refresh</button>
    </div>
    <div class="card gated">
      <h3>Global Memory</h3>
      <div class="row">
        <div>
          <label>Key</label>
          <input id="memKey" placeholder="e.g. personality.preset" />
        </div>
        <div>
          <label>Value</label>
          <input id="memValue" placeholder="e.g. default" />
        </div>
      </div>
      <div style="margin-top: 12px; display:flex; gap: 8px;">
        <button id="getMem">Get</button>
        <button id="setMem">Set</button>
      </div>
      <pre id="memOut"></pre>
    </div>
    <div class="card gated">
      <h3>Settings</h3>
      <div class="row">
        <div>
          <label>Personality Preset</label>
          <select id="personality">
            <option value="default" selected>default</option>
            <option value="evil">evil</option>
          </select>
        </div>
        <div>
          <label>Profanity Level</label>
          <select id="profanity">
            <option>low</option>
            <option selected>medium</option>
            <option>high</option>
          </select>
        </div>
      </div>
      <div style="margin-top: 12px;">
        <button id="saveSettings">Save</button>
        <button id="switchPersona">Switch Persona</button>
      </div>
    </div>
    <div class="card gated">
      <h3>Moderation</h3>
      <div class="row">
        <div>
          <label>Enabled</label>
          <select id="modEnabled">
            <option value="true" selected>true</option>
            <option value="false">false</option>
          </select>
        </div>
        <div>
          <label>Max Caps %</label>
          <input id="modCaps" type="number" value="70" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Max Length</label>
          <input id="modLen" type="number" value="400" />
        </div>
        <div>
          <label>Blocklist (comma-separated)</label>
          <input id="modBlock" placeholder="word1,word2" />
        </div>
      </div>
      <div style="margin-top: 12px;">
        <button id="saveModeration">Save Moderation</button>
      </div>
    </div>
    <div class="card gated">
      <h3>Highlights</h3>
      <p class="small">Chat spike detection creates OBS record markers and saves entries here.</p>
      <button id="refreshHighlights">Refresh</button>
      <pre id="highlights"></pre>
    </div>
    <div class="card gated">
      <h3>Redeems</h3>
      <p class="small">Map channel point reward title to an action (vts_expression:<name>, obs_hotkey:<name>, persona:<id>).</p>
      <div class="row">
        <div>
          <label>Reward Title</label>
          <input id="redeemTitle" placeholder="e.g. Smile" />
        </div>
        <div>
          <label>Action</label>
          <input id="redeemAction" placeholder="e.g. vts_expression:Smile" />
        </div>
      </div>
      <div style="margin-top: 12px; display:flex; gap:8px;">
        <button id="saveRedeem">Save Mapping</button>
        <button id="loadRedeems">Load</button>
      </div>
      <pre id="redeemsOut"></pre>
    </div>
    <div class="card gated">
      <h3>Show Flow</h3>
    <div class="card gated">
      <h3>Self-Test</h3>
      <button id="runSelfTest">Run Self-Test</button>
      <pre id="selfTestOut"></pre>
    </div>
      <p class="small">Cron-based steps. Example: {"cron":"0 * * * *","actions":[{"kind":"obs_scene","value":"Just Chatting"}]}.</p>
      <div>
        <label>Steps JSON</label>
        <textarea id="showflowText" rows="8" placeholder='[{"cron":"*/5 * * * *","actions":[{"kind":"obs_hotkey","value":"NextScene"}]}]'></textarea>
      </div>
      <div style="margin-top: 12px; display:flex; gap:8px;">
        <button id="loadShowflow">Load</button>
        <button id="saveShowflow">Save</button>
      </div>
    </div>
    <script>
      function headers(){
        const h = { };
        const k = localStorage.getItem('apiKey');
        if (k) { h['x-api-key'] = k; }
        return h;
      }
      function applyGate(){
        const hasKey = !!localStorage.getItem('apiKey') || !document.getElementById('apiKey');
        document.querySelectorAll('.gated').forEach(el => { el.style.display = hasKey ? '' : 'none'; });
      }
      async function refreshHealth(){
        const r = await fetch('/api/health', { headers: headers() });
        const j = await r.json();
        document.getElementById('health').textContent = JSON.stringify(j, null, 2);
      }
      document.getElementById('refreshHealth').onclick = refreshHealth;
      refreshHealth();

      document.getElementById('getMem').onclick = async () => {
        const key = document.getElementById('memKey').value.trim();
        const r = await fetch('/api/memory/global/' + encodeURIComponent(key), { headers: headers() });
        const j = await r.json();
        document.getElementById('memOut').textContent = JSON.stringify(j, null, 2);
      };
      document.getElementById('setMem').onclick = async () => {
        const key = document.getElementById('memKey').value.trim();
        const value = document.getElementById('memValue').value.trim();
        const h = headers(); h['Content-Type'] = 'application/json';
        const r = await fetch('/api/memory/global/' + encodeURIComponent(key), { method:'POST', headers: h, body: JSON.stringify({ value }) });
        const j = await r.json();
        document.getElementById('memOut').textContent = JSON.stringify(j, null, 2);
      };
      document.getElementById('saveSettings').onclick = async () => {
        const personality = document.getElementById('personality').value.trim();
        const profanity = document.getElementById('profanity').value.trim();
        const h = headers(); h['Content-Type'] = 'application/json';
        const r = await fetch('/api/settings', { method: 'POST', headers: h, body: JSON.stringify({ 'personality.preset': personality, 'speech.profanity': profanity }) });
        if (r.ok) alert('Saved');
      };
      document.getElementById('switchPersona').onclick = async () => {
        const id = document.getElementById('personality').value.trim();
        const h = headers(); h['Content-Type'] = 'application/json';
        const r = await fetch('/api/persona', { method: 'POST', headers: h, body: JSON.stringify({ id }) });
        if (r.ok) alert('Persona switched');
      };
      document.getElementById('saveModeration').onclick = async () => {
        const enabled = document.getElementById('modEnabled').value;
        const caps = document.getElementById('modCaps').value;
        const len = document.getElementById('modLen').value;
        const block = document.getElementById('modBlock').value;
        const h = headers(); h['Content-Type'] = 'application/json';
        await fetch('/api/moderation', { method: 'POST', headers: h, body: JSON.stringify({ enabled, maxCapsPercent: caps, maxLength: len, blocklist: block }) });
        alert('Moderation saved');
      };
      async function refreshHighlights(){
        try{
          const r = await fetch('/api/highlights', { headers: headers() });
          const j = await r.json();
          document.getElementById('highlights').textContent = JSON.stringify(j, null, 2);
        }catch(e){ document.getElementById('highlights').textContent = String(e); }
      }
      document.getElementById('refreshHighlights').onclick = refreshHighlights;
      document.getElementById('saveRedeem').onclick = async () => {
        const k = document.getElementById('redeemTitle').value.trim();
        const v = document.getElementById('redeemAction').value.trim();
        const body = {}; body[k] = v;
        const h = headers(); h['Content-Type'] = 'application/json';
        await fetch('/api/redeems', { method: 'POST', headers: h, body: JSON.stringify(body) });
        alert('Saved');
      };
      document.getElementById('loadRedeems').onclick = async () => {
        const r = await fetch('/api/redeems', { headers: headers() });
        const j = await r.json();
        document.getElementById('redeemsOut').textContent = JSON.stringify(j, null, 2);
      };
      document.getElementById('saveApiKey').onclick = () => {
        const v = document.getElementById('apiKey').value.trim();
        if (v) localStorage.setItem('apiKey', v); else localStorage.removeItem('apiKey');
        alert('API key saved');
        applyGate();
      };
      (function init(){ const v = localStorage.getItem('apiKey'); if (v) document.getElementById('apiKey').value = v; applyGate(); })();
      document.getElementById('runSelfTest').onclick = async () => {
        const r = await fetch('/api/selftest', { headers: headers() });
        const j = await r.json();
        document.getElementById('selfTestOut').textContent = JSON.stringify(j, null, 2);
      };
      document.getElementById('loadShowflow').onclick = async () => {
        const r = await fetch('/api/showflow');
        const j = await r.json();
        document.getElementById('showflowText').value = JSON.stringify(j.steps ?? [], null, 2);
      };
      document.getElementById('saveShowflow').onclick = async () => {
        const txt = document.getElementById('showflowText').value;
        const steps = JSON.parse(txt || '[]');
        await fetch('/api/showflow', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ steps }) });
        alert('Show flow saved');
      };
    </script>
  </body>
  </html>

